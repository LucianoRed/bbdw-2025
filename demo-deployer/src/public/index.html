<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo Deployer ‚Äî BBDW 2025</title>
  <style>
    :root {
      --bg: #0d1117;
      --bg-card: #161b22;
      --bg-card-hover: #1c2333;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
      --purple: #bc8cff;
      --infra: #58a6ff;
      --mcp: #bc8cff;
      --demo: #d29922;
      --core: #3fb950;
      --radius: 10px;
      --shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      padding: 20px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header h1 { font-size: 24px; font-weight: 700; }
    .header h1 span { color: var(--accent); }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .status-dot {
      width: 10px; height: 10px; border-radius: 50%;
      display: inline-block; margin-right: 6px;
    }
    .status-dot.connected { background: var(--success); box-shadow: 0 0 6px var(--success); }
    .status-dot.disconnected { background: var(--danger); }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn:hover { background: var(--bg-card-hover); border-color: var(--accent); }
    .btn-primary { background: #238636; border-color: #2ea043; }
    .btn-primary:hover { background: #2ea043; }
    .btn-danger { background: #da3633; border-color: #f85149; }
    .btn-danger:hover { background: #f85149; }
    .btn-accent { background: #1f6feb; border-color: #388bfd; }
    .btn-accent:hover { background: #388bfd; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    .btn-lg { padding: 12px 28px; font-size: 15px; font-weight: 600; }

    /* Layout */
    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

    /* Config Panel */
    .config-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
    }
    .config-panel h2 { font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .config-grid.full { grid-template-columns: 1fr; }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group label { font-size: 12px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-group input {
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 14px;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }
    .form-group input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(88,166,255,0.2); }

    /* Action Bar */
    .action-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      align-items: center;
    }
    .action-bar .spacer { flex: 1; }

    /* Components Grid */
    .components-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    /* Component Card */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow); }
    .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .card-icon { font-size: 28px; }
    .card-title { font-size: 15px; font-weight: 600; }
    .card-category {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .cat-infra { background: rgba(88,166,255,0.15); color: var(--infra); }
    .cat-mcp { background: rgba(188,140,255,0.15); color: var(--mcp); }
    .cat-demo { background: rgba(210,153,34,0.15); color: var(--demo); }
    .cat-core { background: rgba(63,185,80,0.15); color: var(--core); }
    .card-desc { font-size: 13px; color: var(--text-muted); line-height: 1.5; margin-bottom: 14px; }
    .card-footer { display: flex; flex-direction: column; gap: 8px; }
    .card-footer-row { display: flex; align-items: center; justify-content: space-between; }
    .card-actions { display: flex; gap: 6px; align-items: center; }
    .btn-trash { background: transparent; border: 1px solid #f85149; color: #f85149; padding: 4px 8px; font-size: 14px; cursor: pointer; border-radius: 6px; }
    .btn-trash:hover { background: #da3633; color: #fff; }

    /* Status badge */
    .badge {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 12px;
      font-weight: 600;
    }
    .badge-not-deployed { background: rgba(139,148,158,0.15); color: var(--text-muted); }
    .badge-deploying { background: rgba(210,153,34,0.15); color: var(--warning); }
    .badge-deployed { background: rgba(63,185,80,0.15); color: var(--success); }
    .badge-failed { background: rgba(248,81,73,0.15); color: var(--danger); }

    /* Progress bar on card */
    .card-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: var(--accent);
      transition: width 0.3s;
    }
    .card-progress.deploying {
      animation: progress-pulse 1.5s ease-in-out infinite;
      width: 100%;
      background: linear-gradient(90deg, var(--accent), var(--purple), var(--accent));
      background-size: 200% 100%;
    }
    @keyframes progress-pulse {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* Route link */
    .route-link {
      color: var(--accent);
      font-size: 12px;
      text-decoration: none;
      font-family: 'SF Mono', monospace;
    }
    .route-link:hover { text-decoration: underline; }

    /* Log Panel */
    .log-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 24px;
    }
    .log-header {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .log-header h3 { font-size: 14px; }
    .log-content {
      padding: 16px 20px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      color: var(--text-muted);
      line-height: 1.6;
    }
    .log-content .log-ok { color: var(--success); }
    .log-content .log-err { color: var(--danger); }
    .log-content .log-changed { color: var(--warning); }

    /* Details Panel (overlay) */
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 200;
      justify-content: center;
      align-items: center;
    }
    .overlay.active { display: flex; }
    .detail-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      padding: 28px;
    }
    .detail-panel h2 { margin-bottom: 16px; }
    .detail-info { margin-bottom: 16px; }
    .detail-row { display: flex; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .detail-label { min-width: 120px; color: var(--text-muted); font-size: 13px; font-weight: 600; }
    .detail-value { font-size: 13px; flex: 1; }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 18px;
      font-size: 13px;
      box-shadow: var(--shadow);
      animation: slideIn 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toast.success { border-left: 3px solid var(--success); }
    .toast.error { border-left: 3px solid var(--danger); }
    .toast.info { border-left: 3px solid var(--accent); }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Tabs */
    .tabs { display: flex; gap: 0; margin-bottom: 24px; border-bottom: 1px solid var(--border); }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Deploy Details page */
    .deploy-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 14px;
    }
    .detail-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }
    .detail-card h4 {
      font-size: 14px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .detail-card .info-row {
      font-size: 12px;
      padding: 4px 0;
      display: flex;
      gap: 8px;
    }
    .detail-card .info-label {
      color: var(--text-muted);
      min-width: 80px;
      font-weight: 600;
    }
    .detail-card .info-value {
      font-family: 'SF Mono', monospace;
      word-break: break-all;
    }

    /* ========== OFERTAS ========== */
    .ofertas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    .oferta-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 28px;
      cursor: pointer;
      transition: all 0.25s;
      position: relative;
      overflow: hidden;
    }
    .oferta-card:hover {
      border-color: var(--accent);
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .oferta-icon {
      font-size: 48px;
      display: block;
      margin-bottom: 14px;
    }
    .oferta-name {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .oferta-desc {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.6;
      margin-bottom: 14px;
    }
    .oferta-components {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .oferta-comp-tag {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 12px;
      background: rgba(88,166,255,0.12);
      color: var(--accent);
      font-weight: 500;
    }

    /* ========== TOPOLOGIA ========== */
    .topology-view {
      display: none;
    }
    .topology-view.active {
      display: block;
    }
    .topology-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .topology-header h2 {
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .topology-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .topology-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 500px;
      position: relative;
    }
    .topology-svg {
      width: 100%;
      max-width: 700px;
      height: 500px;
    }

    /* Topology status list */
    .topo-status-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }
    .topo-status-item {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .topo-status-icon { font-size: 24px; }
    .topo-status-info { flex: 1; }
    .topo-status-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .topo-status-state { font-size: 12px; }
    .topo-status-route {
      font-size: 11px;
      color: var(--accent);
      text-decoration: none;
      font-family: 'SF Mono', monospace;
      word-break: break-all;
    }
    .topo-status-route:hover { text-decoration: underline; }

    @media (max-width: 768px) {
      .config-grid { grid-template-columns: 1fr; }
      .components-grid { grid-template-columns: 1fr; }
      .ofertas-grid { grid-template-columns: 1fr; }
      .header { flex-direction: column; gap: 12px; }
      .topology-svg { height: 380px; }
    }

    /* Modal overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 32px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .modal-box .modal-icon {
      font-size: 48px;
      margin-bottom: 16px;
      display: block;
    }
    .modal-box h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text);
    }
    .modal-box p {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 20px;
    }
    .modal-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      margin: 0 auto;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* SVG animations */
    @keyframes dash-flow {
      to { stroke-dashoffset: -20; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <h1>üöÄ <span>Demo Deployer</span> ‚Äî BBDW 2025</h1>
    <div class="header-actions">
      <span><span class="status-dot disconnected" id="wsStatus"></span> <span id="wsLabel">Desconectado</span></span>
    </div>
  </div>

  <div class="container">
    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="ofertas" onclick="switchTab('ofertas')">üéØ Ofertas</div>
      <div class="tab" data-tab="deploy" onclick="switchTab('deploy')">‚ö° Deploy</div>
      <div class="tab" data-tab="details" onclick="switchTab('details')">üìã Detalhes</div>
      <div class="tab" data-tab="logs" onclick="switchTab('logs')">üìú Logs</div>
    </div>

    <!-- TAB: Ofertas -->
    <div class="tab-content active" id="tab-ofertas">
      <div id="ofertasList">
        <h2 style="margin-bottom: 8px;">üéØ Cat√°logo de Ofertas</h2>
        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 20px;">
          Selecione uma oferta para visualizar a topologia e deployar todos os componentes de uma vez.
        </p>
        <div class="ofertas-grid" id="ofertasGrid"></div>
      </div>
      <!-- Topologia (aparece ao clicar numa oferta) -->
      <div class="topology-view" id="topologyView">
        <div class="topology-header">
          <h2>
            <button class="btn btn-sm" onclick="backToOfertas()">‚Üê Voltar</button>
            <span id="topoTitle"></span>
          </h2>
          <div class="topology-actions">
            <button class="btn btn-primary btn-lg" id="btnDeployOferta" onclick="deployCurrentOferta()">üöÄ Deployar Oferta</button>
            <button class="btn" onclick="refreshClusterStatus()">üîÑ Status</button>
            <button class="btn btn-danger" id="btnCleanupOferta" onclick="cleanupCurrentOferta()">üóëÔ∏è Limpar Oferta</button>
          </div>
        </div>
        <div class="topology-container">
          <svg class="topology-svg" id="topologySvg" viewBox="0 0 700 500"></svg>
        </div>
        <div class="topo-status-list" id="topoStatusList"></div>
      </div>
    </div>

    <!-- TAB: Deploy -->
    <div class="tab-content" id="tab-deploy">
      <!-- Config -->
      <div class="config-panel">
        <h2>‚öôÔ∏è Configura√ß√£o do Cluster</h2>
        <div class="config-grid">
          <div class="form-group">
            <label>OpenShift API URL</label>
            <input type="text" id="ocpApiUrl" placeholder="https://api.cluster.example.com:6443">
          </div>
          <div class="form-group">
            <label>Token</label>
            <input type="password" id="ocpToken" placeholder="sha256~xxxx...">
          </div>
        </div>
        <div class="config-grid" style="margin-top: 12px;">
          <div class="form-group">
            <label>Git Repo URL</label>
            <input type="text" id="gitRepoUrl" placeholder="https://github.com/usuario/bbdw-2025.git">
          </div>
          <div class="form-group">
            <label>OpenAI API Key</label>
            <input type="password" id="openaiApiKey" placeholder="sk-...">
          </div>
        </div>
        <p style="font-size: 11px; color: var(--text-muted); margin-top: 10px;">Cada componente ser√° deployado no seu pr√≥prio namespace (ex: mcp-server-matriculas ‚Üí namespace mcp-server-matriculas)</p>
        <div style="margin-top: 14px; display: flex; gap: 10px;">
          <button class="btn btn-accent" onclick="saveConfig()">üíæ Salvar Config</button>
          <button class="btn" onclick="testConnection()">üîå Testar Conex√£o</button>
        </div>
      </div>

      <!-- Action Bar -->
      <div class="action-bar">
        <button class="btn btn-primary" onclick="deployAllComponents()">üöÄ Deploy Completo</button>
        <button class="btn" onclick="refreshClusterStatus()">üîÑ Atualizar Status</button>
        <button class="btn" onclick="refreshAllTokens()">üîë Atualizar Tokens</button>
        <div class="spacer"></div>
        <button class="btn btn-danger" onclick="cleanupAll()">üóëÔ∏è Limpar Tudo</button>
      </div>

      <!-- Components Grid -->
      <div class="components-grid" id="componentsGrid"></div>
    </div>

    <!-- TAB: Detalhes -->
    <div class="tab-content" id="tab-details">
      <h2 style="margin-bottom: 16px;">üìã Detalhes dos Deploys</h2>
      <div class="deploy-details-grid" id="detailsGrid"></div>
    </div>

    <!-- TAB: Logs -->
    <div class="tab-content" id="tab-logs">
      <div class="log-panel">
        <div class="log-header">
          <h3>üìú Logs em Tempo Real</h3>
          <button class="btn btn-sm" onclick="clearLogs()">Limpar</button>
        </div>
        <div class="log-content" id="logContent">Aguardando a√ß√µes...\n</div>
      </div>
    </div>
  </div>

  <!-- Detail Overlay -->
  <div class="overlay" id="detailOverlay" onclick="closeDetail(event)">
    <div class="detail-panel" id="detailPanel" onclick="event.stopPropagation()">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 id="detailTitle">Detalhes</h2>
        <button class="btn btn-sm" onclick="closeDetail()">‚úï</button>
      </div>
      <div id="detailBody"></div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container" id="toasts"></div>

  <!-- Modal de loading -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-box">
      <span class="modal-icon" id="modalIcon"></span>
      <h3 id="modalTitle"></h3>
      <p id="modalMessage"></p>
      <div class="modal-spinner"></div>
    </div>
  </div>

<script>
  // ---- State ----
  let state = { config: {}, components: {}, definitions: [] };
  let ofertas = [];
  let currentOferta = null;
  let ws = null;
  let logBuffer = '';
  let pendingModalJob = null;
  let deployAllRunning = false;
  let ofertaDeployRunning = false;

  // ---- Init ----
  window.addEventListener('load', async () => {
    await fetchState();
    await fetchOfertas();
    connectWebSocket();
  });

  // ---- API Calls ----
  async function fetchState() {
    try {
      const res = await fetch('/api/state');
      state = await res.json();
      renderComponents();
      renderDetails();
      if (currentOferta) renderTopologyStatus();
      if (state.config) {
        document.getElementById('ocpApiUrl').value = state.config.ocpApiUrl || '';
        document.getElementById('gitRepoUrl').value = state.config.gitRepoUrl || '';
        const tokenInput = document.getElementById('ocpToken');
        if (state.config.ocpToken === '***') {
          tokenInput.value = '';
          tokenInput.placeholder = 'üîí Token salvo (deixe vazio para manter)';
        }
        const openaiInput = document.getElementById('openaiApiKey');
        if (state.config.openaiApiKey === '***') {
          openaiInput.value = '';
          openaiInput.placeholder = 'üîí Key salva (deixe vazio para manter)';
        }
      }
    } catch (e) {
      showToast('Erro ao carregar estado', 'error');
    }
  }

  async function fetchOfertas() {
    try {
      const res = await fetch('/api/ofertas');
      ofertas = await res.json();
      renderOfertas();
    } catch (e) {
      console.error('Erro ao carregar ofertas:', e);
    }
  }

  async function saveConfig() {
    const config = {
      ocpApiUrl: document.getElementById('ocpApiUrl').value,
      ocpToken: document.getElementById('ocpToken').value,
      gitRepoUrl: document.getElementById('gitRepoUrl').value,
      openaiApiKey: document.getElementById('openaiApiKey').value,
    };
    try {
      await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(config) });
      showToast('Configura√ß√£o salva!', 'success');
    } catch (e) {
      showToast('Erro ao salvar config', 'error');
    }
  }

  async function testConnection() {
    await saveConfig();
    showToast('Testando conex√£o...', 'info');
    try {
      const res = await fetch('/api/refresh', { method: 'POST' });
      const data = await res.json();
      if (data.success) {
        showToast('Conex√£o OK! Cluster acess√≠vel.', 'success');
      } else {
        showToast(data.error || 'Falha na conex√£o. Verifique URL e Token.', 'error');
      }
    } catch (e) {
      showToast('Erro ao testar conex√£o', 'error');
    }
  }

  async function deployComponent(id) {
    const comp = state.definitions?.find(c => c.id === id);
    const name = comp ? comp.name : id;
    showModal('‚ñ∂ Deployando ' + name + '...', 'Aguarde enquanto o build e deploy acontecem no OpenShift...', 'üöÄ');
    try {
      const res = await fetch('/api/deploy/' + id, { method: 'POST' });
      const data = await res.json();
      if (data.error) {
        hideModal();
        throw new Error(data.error);
      }
      pendingModalJob = id;
    } catch (e) {
      hideModal();
      showToast('Erro: ' + e.message, 'error');
    }
  }

  async function refreshAllTokens() {
    showModal('üîë Atualizando tokens...', 'Atualizando K8S_BEARER_TOKEN em todos os deployments...', 'üîë');
    try {
      const res = await fetch('/api/refresh-tokens', { method: 'POST' });
      const data = await res.json();
      hideModal();
      if (data.success) {
        const updated = data.results.filter(r => r.status === 'updated').length;
        const skipped = data.results.filter(r => r.status === 'skipped').length;
        showToast('Tokens atualizados! ' + updated + ' atualizado(s), ' + skipped + ' ignorado(s).', 'success');
      } else {
        showToast('Falha ao atualizar tokens', 'error');
      }
    } catch (e) {
      hideModal();
      showToast('Erro: ' + e.message, 'error');
    }
  }

  async function deployAllComponents() {
    if (!confirm('Iniciar deploy completo de todos os componentes?')) return;
    showModal('üöÄ Deploy Completo...', 'Deployando todos os componentes em sequ√™ncia. Isso pode levar v√°rios minutos...', 'üöÄ');
    deployAllRunning = true;
    try {
      await fetch('/api/deploy-all', { method: 'POST' });
    } catch (e) {
      hideModal();
      deployAllRunning = false;
      showToast('Erro: ' + e.message, 'error');
    }
  }

  async function refreshClusterStatus() {
    showModal('üîÑ Atualizando status...', 'Consultando o cluster para verificar o estado de cada componente...', 'üîÑ');
    try {
      await fetch('/api/refresh', { method: 'POST' });
      await fetchState();
      hideModal();
      showToast('Status atualizado', 'success');
    } catch (e) {
      hideModal();
      showToast('Erro ao atualizar', 'error');
    }
  }

  let cleanupRunning = false;

  async function cleanupOne(compId, compName) {
    if (!confirm('‚ö†Ô∏è Remover "' + compName + '" e seu namespace? Continuar?')) return;
    cleanupRunning = true;
    showModal('üóëÔ∏è Removendo ' + compName + '...', 'Excluindo namespace e recursos de ' + compName + '...');
    try {
      const res = await fetch('/api/cleanup/' + compId, { method: 'POST' });
      const data = await res.json();
      if (!cleanupRunning) return;
      cleanupRunning = false;
      hideModal();
      if (data.success) {
        showToast(compName + ' removido com sucesso!', 'success');
      } else {
        showToast('Falha ao remover ' + compName + ': ' + (data.output || ''), 'error');
      }
      await fetchState();
    } catch (e) {
      cleanupRunning = false;
      hideModal();
      showToast('Erro ao remover ' + compName, 'error');
    }
  }

  async function cleanupAll() {
    if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso vai remover TODOS os recursos e namespaces da demo. Continuar?')) return;
    cleanupRunning = true;
    showModal('üóëÔ∏è Limpando tudo...', 'Excluindo namespaces e todos os recursos. Isso pode levar alguns minutos...');
    try {
      const res = await fetch('/api/cleanup', { method: 'POST' });
      const data = await res.json();
      if (!cleanupRunning) return;
      cleanupRunning = false;
      hideModal();
      if (data.success) {
        showToast('Cleanup conclu√≠do! Todos os namespaces foram exclu√≠dos.', 'success');
      } else {
        showToast('Cleanup parcial: ' + (data.output || 'verifique os logs'), 'error');
      }
      await fetchState();
    } catch (e) {
      cleanupRunning = false;
      hideModal();
      showToast('Erro no cleanup', 'error');
    }
  }

  // ---- Ofertas ----
  async function deployCurrentOferta() {
    if (!currentOferta) return;
    if (!confirm('Deployar a oferta "' + currentOferta.name + '" com ' + currentOferta.componentIds.length + ' componentes?')) return;
    ofertaDeployRunning = true;
    showModal('üöÄ Deployando ' + currentOferta.name + '...', 'Deployando todos os componentes da oferta em sequ√™ncia...', 'üöÄ');
    try {
      await fetch('/api/ofertas/' + currentOferta.id + '/deploy', { method: 'POST' });
    } catch (e) {
      hideModal();
      ofertaDeployRunning = false;
      showToast('Erro: ' + e.message, 'error');
    }
  }

  async function cleanupCurrentOferta() {
    if (!currentOferta) return;
    if (!confirm('‚ö†Ô∏è Remover todos os componentes da oferta "' + currentOferta.name + '"?')) return;
    cleanupRunning = true;
    showModal('üóëÔ∏è Limpando ' + currentOferta.name + '...', 'Removendo componentes da oferta...');
    try {
      const res = await fetch('/api/ofertas/' + currentOferta.id + '/cleanup', { method: 'POST' });
      const data = await res.json();
      cleanupRunning = false;
      hideModal();
      if (data.success) {
        showToast('Oferta "' + currentOferta.name + '" removida!', 'success');
      } else {
        showToast('Cleanup parcial. Verifique os logs.', 'error');
      }
      await fetchState();
    } catch (e) {
      cleanupRunning = false;
      hideModal();
      showToast('Erro: ' + e.message, 'error');
    }
  }

  function openOferta(ofertaId) {
    currentOferta = ofertas.find(o => o.id === ofertaId);
    if (!currentOferta) return;
    document.getElementById('ofertasList').style.display = 'none';
    document.getElementById('topologyView').classList.add('active');
    document.getElementById('topoTitle').textContent = currentOferta.icon + ' ' + currentOferta.name;
    renderTopology();
    renderTopologyStatus();
  }

  function backToOfertas() {
    currentOferta = null;
    document.getElementById('topologyView').classList.remove('active');
    document.getElementById('ofertasList').style.display = 'block';
  }

  // ---- Render Ofertas Grid ----
  function renderOfertas() {
    const grid = document.getElementById('ofertasGrid');
    grid.innerHTML = ofertas.map(o => {
      return '<div class="oferta-card" onclick="openOferta(\'' + o.id + '\')" style="border-top: 4px solid ' + o.color + ';">'
        + '<span class="oferta-icon">' + o.icon + '</span>'
        + '<div class="oferta-name">' + o.name + '</div>'
        + '<div class="oferta-desc">' + o.description + '</div>'
        + '<div class="oferta-components">'
        + o.topology.nodes.map(n => '<span class="oferta-comp-tag">' + n.icon + ' ' + n.label + '</span>').join('')
        + '</div>'
        + '</div>';
    }).join('');
  }

  // ---- Render Topologia SVG ----
  function renderTopology() {
    if (!currentOferta) return;
    var svg = document.getElementById('topologySvg');
    var t = currentOferta.topology;
    var cx = 350, cy = 250;
    var radius = 170;
    var nodes = t.nodes;
    var n = nodes.length;

    var html = '';

    // Defs
    html += '<defs>'
      + '<filter id="glow"><feGaussianBlur stdDeviation="3" result="coloredBlur"/>'
      + '<feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>'
      + '<filter id="shadow"><feDropShadow dx="0" dy="2" stdDeviation="4" flood-color="rgba(0,0,0,0.5)"/></filter>'
      + '</defs>';

    // Posi√ß√µes dos n√≥s
    var positions = nodes.map(function(node, i) {
      var angle = (2 * Math.PI * i / n) - Math.PI / 2;
      return {
        x: cx + radius * Math.cos(angle),
        y: cy + radius * Math.sin(angle),
        node: node,
      };
    });

    // Linhas de conex√£o (centro -> n√≥s)
    positions.forEach(function(p) {
      var compState = state.components[p.node.componentId] || {};
      var isDeployed = compState.status === 'deployed';
      var isDeploying = compState.status === 'deploying';
      var lineColor = isDeployed ? '#3fb950' : isDeploying ? '#d29922' : '#30363d';
      var dashAttr = isDeploying ? ' stroke-dasharray="6 4" style="animation: dash-flow 0.8s linear infinite;"' : '';

      html += '<line x1="' + cx + '" y1="' + cy + '" x2="' + p.x + '" y2="' + p.y + '"'
        + ' stroke="' + lineColor + '" stroke-width="2" stroke-opacity="0.6"' + dashAttr + '/>';
    });

    // N√≥ central com anima√ß√£o pulsante
    html += '<circle cx="' + cx + '" cy="' + cy + '" r="52" fill="' + t.center.color + '" fill-opacity="0.15"'
      + ' stroke="' + t.center.color + '" stroke-width="2.5" filter="url(#glow)"/>';
    html += '<circle cx="' + cx + '" cy="' + cy + '" r="52" fill="none"'
      + ' stroke="' + t.center.color + '" stroke-width="1" stroke-opacity="0.3">'
      + '<animate attributeName="r" values="52;65;52" dur="3s" repeatCount="indefinite"/>'
      + '<animate attributeName="stroke-opacity" values="0.3;0;0.3" dur="3s" repeatCount="indefinite"/>'
      + '</circle>';
    html += '<text x="' + cx + '" y="' + (cy - 8) + '" text-anchor="middle" font-size="32">' + t.center.icon + '</text>';
    html += '<text x="' + cx + '" y="' + (cy + 22) + '" text-anchor="middle" fill="' + t.center.color + '"'
      + ' font-size="13" font-weight="700" font-family="-apple-system, sans-serif">' + t.center.label + '</text>';

    // N√≥s sat√©lite
    positions.forEach(function(p) {
      var compState = state.components[p.node.componentId] || {};
      var status = compState.status || 'not-deployed';
      var isDeployed = status === 'deployed';
      var isDeploying = status === 'deploying';
      var isFailed = status === 'failed';

      var ringColor = isDeployed ? '#3fb950' : isFailed ? '#f85149' : isDeploying ? '#d29922' : '#30363d';
      var bgOpacity = isDeployed ? '0.2' : '0.1';

      html += '<circle cx="' + p.x + '" cy="' + p.y + '" r="44" fill="' + p.node.color + '" fill-opacity="' + bgOpacity + '"'
        + ' stroke="' + ringColor + '" stroke-width="2" filter="url(#shadow)"/>';

      // Pulsing ring quando deploying
      if (isDeploying) {
        html += '<circle cx="' + p.x + '" cy="' + p.y + '" r="44" fill="none"'
          + ' stroke="' + p.node.color + '" stroke-width="1.5">'
          + '<animate attributeName="r" values="44;58;44" dur="1.5s" repeatCount="indefinite"/>'
          + '<animate attributeName="stroke-opacity" values="0.5;0;0.5" dur="1.5s" repeatCount="indefinite"/>'
          + '</circle>';
      }

      // Status dot
      var dotColor = isDeployed ? '#3fb950' : isFailed ? '#f85149' : isDeploying ? '#d29922' : '#555';
      html += '<circle cx="' + (p.x + 30) + '" cy="' + (p.y - 30) + '" r="6" fill="' + dotColor + '" stroke="#0d1117" stroke-width="2"/>';

      html += '<text x="' + p.x + '" y="' + (p.y - 6) + '" text-anchor="middle" font-size="24">' + p.node.icon + '</text>';
      html += '<text x="' + p.x + '" y="' + (p.y + 16) + '" text-anchor="middle" fill="' + p.node.color + '"'
        + ' font-size="11" font-weight="600" font-family="-apple-system, sans-serif">' + p.node.label + '</text>';
    });

    svg.innerHTML = html;
  }

  // ---- Render Topology Status List ----
  function renderTopologyStatus() {
    if (!currentOferta) return;
    var list = document.getElementById('topoStatusList');

    list.innerHTML = currentOferta.topology.nodes.map(function(node) {
      var cs = state.components[node.componentId] || { status: 'not-deployed' };
      var statusClass = cs.status.replace(' ', '-');

      var routeHtml = cs.route
        ? '<a class="topo-status-route" href="http://' + cs.route + '" target="_blank">üîó ' + cs.route + '</a>'
        : '';

      var deployBtnClass = cs.status === 'deploying' ? 'btn btn-sm' : 'btn btn-sm btn-primary';
      var deployBtnDisabled = cs.status === 'deploying' ? ' disabled' : '';
      var deployBtnLabel = cs.status === 'deploying' ? '‚è≥' : '‚ñ∂';

      var trashBtn = cs.status !== 'not-deployed'
        ? '<button class="btn-trash" onclick="cleanupOne(\'' + node.componentId + '\', \'' + node.label + '\')" title="Remover">üóëÔ∏è</button>'
        : '';

      return '<div class="topo-status-item">'
        + '<span class="topo-status-icon">' + node.icon + '</span>'
        + '<div class="topo-status-info">'
        + '<div class="topo-status-name">' + node.label + '</div>'
        + '<div class="topo-status-state"><span class="badge badge-' + statusClass + '">' + formatStatus(cs.status) + '</span></div>'
        + routeHtml
        + '</div>'
        + '<div style="display: flex; gap: 6px;">'
        + '<button class="' + deployBtnClass + '" onclick="deployComponent(\'' + node.componentId + '\')"' + deployBtnDisabled + '>' + deployBtnLabel + '</button>'
        + trashBtn
        + '</div>'
        + '</div>';
    }).join('');

    // Atualizar SVG tamb√©m
    renderTopology();
  }

  // ---- WebSocket ----
  function connectWebSocket() {
    var protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(protocol + '//' + location.host + '/ws');

    ws.onopen = function() {
      document.getElementById('wsStatus').className = 'status-dot connected';
      document.getElementById('wsLabel').textContent = 'Conectado';
    };

    ws.onclose = function() {
      document.getElementById('wsStatus').className = 'status-dot disconnected';
      document.getElementById('wsLabel').textContent = 'Desconectado';
      setTimeout(connectWebSocket, 3000);
    };

    ws.onmessage = function(e) {
      try {
        var event = JSON.parse(e.data);
        handleWsEvent(event);
      } catch (err) { /* ignore */ }
    };
  }

  function handleWsEvent(event) {
    switch (event.type) {
      case 'init':
        state = event.data;
        renderComponents();
        renderDetails();
        if (currentOferta) renderTopologyStatus();
        break;

      case 'component-update':
        state.components[event.componentId] = event.data;
        renderComponents();
        renderDetails();
        if (currentOferta) renderTopologyStatus();
        break;

      case 'job-output':
        appendLog(event.data);
        break;

      case 'job-start':
        if (deployAllRunning) {
          var comp = state.definitions ? state.definitions.find(function(c) { return c.id === event.componentId; }) : null;
          var name = comp ? comp.name : event.componentId;
          updateModal('üöÄ Deployando: ' + name + '...', 'Componente atual: ' + name);
        }
        if (ofertaDeployRunning && currentOferta) {
          var node = currentOferta.topology.nodes.find(function(n) { return n.componentId === event.componentId; });
          if (node) {
            updateModal('üöÄ Deployando: ' + node.label + '...', 'Componente atual: ' + node.label);
          }
        }
        break;

      case 'job-complete':
        if (event.success) {
          showToast('Deploy "' + event.componentId + '" conclu√≠do ‚úì', 'success');
        } else {
          showToast('Deploy "' + event.componentId + '" falhou ‚úó', 'error');
        }
        if (pendingModalJob === event.componentId) {
          hideModal();
          pendingModalJob = null;
        }
        fetchState();
        break;

      case 'job-error':
        showToast('Erro em "' + event.componentId + '": ' + event.error, 'error');
        if (pendingModalJob === event.componentId) {
          hideModal();
          pendingModalJob = null;
        }
        break;

      case 'deploy-all-complete':
      case 'deploy-all-stopped':
        if (deployAllRunning) {
          hideModal();
          deployAllRunning = false;
          showToast('Deploy completo finalizado!', 'success');
          fetchState();
        }
        break;

      case 'oferta-start':
        break;

      case 'oferta-complete':
        if (ofertaDeployRunning) {
          hideModal();
          ofertaDeployRunning = false;
          showToast('Oferta deployada com sucesso! (' + event.total + ' componentes)', 'success');
          fetchState();
        }
        break;

      case 'oferta-stopped':
        if (ofertaDeployRunning) {
          hideModal();
          ofertaDeployRunning = false;
          showToast('Deploy da oferta parou: ' + event.reason, 'error');
          fetchState();
        }
        break;

      case 'oferta-cleanup-complete':
        if (cleanupRunning) {
          cleanupRunning = false;
          hideModal();
          showToast(event.summary || 'Cleanup da oferta conclu√≠do', event.success ? 'success' : 'error');
          fetchState();
        }
        break;

      case 'config-update':
        state.config = event.data;
        break;

      case 'cleanup-output':
        appendLog(event.data);
        if (cleanupRunning && event.data.trim()) {
          var lines = event.data.trim().split('\n');
          var lastLine = lines[lines.length - 1];
          if (lastLine.indexOf('‚ïê‚ïê‚ïê') >= 0 || lastLine.indexOf('‚úÖ') >= 0 || lastLine.indexOf('‚ö†Ô∏è') >= 0 || lastLine.indexOf('üóëÔ∏è') >= 0) {
            updateModal('üóëÔ∏è Limpando...', lastLine);
          }
        }
        break;

      case 'cleanup-complete':
        if (cleanupRunning) {
          cleanupRunning = false;
          hideModal();
          if (event.success) {
            showToast('Cleanup conclu√≠do! ' + (event.summary || ''), 'success');
          } else {
            showToast('Cleanup parcial: ' + (event.summary || 'verifique os logs'), 'error');
          }
          fetchState();
        }
        break;
    }
  }

  // ---- Rendering ----
  function renderComponents() {
    var grid = document.getElementById('componentsGrid');
    if (!state.definitions || state.definitions.length === 0) return;

    grid.innerHTML = state.definitions
      .sort(function(a, b) { return a.order - b.order; })
      .map(function(comp) {
        var cs = state.components[comp.id] || { status: 'not-deployed' };
        var statusClass = cs.status.replace(' ', '-');
        var isDeploying = cs.status === 'deploying';
        var isDeployed = cs.status === 'deployed';

        var routeHtml = (isDeployed && cs.route)
          ? '<div><a class="route-link" href="http://' + cs.route + '" target="_blank" style="font-size:11px; word-break:break-all;">üîó ' + cs.route + '</a></div>'
          : '';

        var trashBtn = cs.status !== 'not-deployed'
          ? '<button class="btn-trash" onclick="cleanupOne(\'' + comp.id + '\', \'' + comp.name + '\')" title="Remover este componente">üóëÔ∏è</button>'
          : '';

        var progressBar = '';
        if (isDeploying) progressBar = '<div class="card-progress deploying"></div>';
        else if (isDeployed) progressBar = '<div class="card-progress" style="width:100%; background: var(--success);"></div>';
        else if (cs.status === 'failed') progressBar = '<div class="card-progress" style="width:100%; background: var(--danger);"></div>';

        return '<div class="card" data-id="' + comp.id + '">'
          + '<div class="card-header">'
          + '<span class="card-icon">' + comp.icon + '</span>'
          + '<div>'
          + '<div class="card-title">' + comp.name + '</div>'
          + '<span class="card-category cat-' + comp.category + '">' + comp.category + '</span>'
          + '</div></div>'
          + '<div class="card-desc">' + comp.description + '<br><span style="font-size:11px; color:var(--text-muted);">namespace: <b>' + (comp.namespace || comp.id) + '</b></span></div>'
          + '<div class="card-footer"><div class="card-footer-row">'
          + '<span class="badge badge-' + statusClass + '">' + formatStatus(cs.status) + '</span>'
          + '<div class="card-actions">'
          + '<button class="btn btn-sm ' + (isDeploying ? '' : 'btn-primary') + '" onclick="deployComponent(\'' + comp.id + '\')" ' + (isDeploying ? 'disabled' : '') + '>'
          + (isDeploying ? '‚è≥ ...' : '‚ñ∂ Deploy') + '</button>'
          + trashBtn
          + '<button class="btn btn-sm" onclick="showDetail(\'' + comp.id + '\')">üìã</button>'
          + '</div></div>'
          + routeHtml
          + '</div>'
          + progressBar
          + '</div>';
      }).join('');
  }

  function renderDetails() {
    var grid = document.getElementById('detailsGrid');
    if (!state.definitions) return;

    grid.innerHTML = state.definitions
      .sort(function(a, b) { return a.order - b.order; })
      .map(function(comp) {
        var cs = state.components[comp.id] || { status: 'not-deployed' };
        var routeHtml = cs.route
          ? '<div class="info-row"><span class="info-label">Rota:</span><span class="info-value"><a class="route-link" href="http://' + cs.route + '" target="_blank">' + cs.route + '</a></span></div>'
          : '';
        var startHtml = cs.startedAt
          ? '<div class="info-row"><span class="info-label">In√≠cio:</span><span class="info-value">' + new Date(cs.startedAt).toLocaleString('pt-BR') + '</span></div>'
          : '';
        var endHtml = cs.finishedAt
          ? '<div class="info-row"><span class="info-label">Fim:</span><span class="info-value">' + new Date(cs.finishedAt).toLocaleString('pt-BR') + '</span></div>'
          : '';
        var errHtml = cs.error
          ? '<div class="info-row"><span class="info-label" style="color:var(--danger)">Erro:</span><span class="info-value" style="color:var(--danger)">' + cs.error + '</span></div>'
          : '';
        var portHtml = comp.port
          ? '<div class="info-row"><span class="info-label">Porta:</span><span class="info-value">' + comp.port + '</span></div>'
          : '';

        return '<div class="detail-card">'
          + '<h4>' + comp.icon + ' ' + comp.name + ' <span class="badge badge-' + cs.status.replace(' ','-') + '" style="font-size:10px;">' + formatStatus(cs.status) + '</span></h4>'
          + '<div class="info-row"><span class="info-label">ID:</span><span class="info-value">' + comp.id + '</span></div>'
          + '<div class="info-row"><span class="info-label">Namespace:</span><span class="info-value">' + (comp.namespace || comp.id) + '</span></div>'
          + '<div class="info-row"><span class="info-label">Categoria:</span><span class="info-value">' + comp.category + '</span></div>'
          + routeHtml + startHtml + endHtml + errHtml + portHtml
          + '</div>';
      }).join('');
  }

  function formatStatus(status) {
    var map = {
      'not-deployed': '‚≠ï N√£o deployado',
      'deploying': 'üîÑ Deployando...',
      'deployed': '‚úÖ Deployado',
      'failed': '‚ùå Falhou',
    };
    return map[status] || status;
  }

  // ---- Detail Overlay ----
  function showDetail(id) {
    var comp = state.definitions.find(function(c) { return c.id === id; });
    var cs = state.components[id] || {};
    document.getElementById('detailTitle').textContent = comp.icon + ' ' + comp.name;

    var routeHtml = cs.route
      ? '<div class="detail-row"><span class="detail-label">Rota:</span><span class="detail-value"><a class="route-link" href="http://' + cs.route + '" target="_blank">' + cs.route + '</a></span></div>'
      : '';
    var portHtml = comp.port
      ? '<div class="detail-row"><span class="detail-label">Porta:</span><span class="detail-value">' + comp.port + '</span></div>'
      : '';
    var startHtml = cs.startedAt
      ? '<div class="detail-row"><span class="detail-label">In√≠cio:</span><span class="detail-value">' + new Date(cs.startedAt).toLocaleString('pt-BR') + '</span></div>'
      : '';
    var endHtml = cs.finishedAt
      ? '<div class="detail-row"><span class="detail-label">Fim:</span><span class="detail-value">' + new Date(cs.finishedAt).toLocaleString('pt-BR') + '</span></div>'
      : '';
    var errHtml = cs.error
      ? '<div class="detail-row"><span class="detail-label" style="color:var(--danger)">Erro:</span><span class="detail-value" style="color:var(--danger)">' + cs.error + '</span></div>'
      : '';
    var logsHtml = cs.logs
      ? '<div class="log-panel" style="margin-top:16px;"><div class="log-header"><h3>Logs do Deploy</h3></div>'
        + '<div class="log-content" style="max-height:300px;">' + colorizeLogs(cs.logs) + '</div></div>'
      : '';

    document.getElementById('detailBody').innerHTML =
      '<div class="detail-info">'
      + '<div class="detail-row"><span class="detail-label">Status:</span><span class="detail-value">' + formatStatus(cs.status) + '</span></div>'
      + '<div class="detail-row"><span class="detail-label">Namespace:</span><span class="detail-value">' + (comp.namespace || comp.id) + '</span></div>'
      + '<div class="detail-row"><span class="detail-label">Categoria:</span><span class="detail-value">' + comp.category + '</span></div>'
      + routeHtml + portHtml + startHtml + endHtml + errHtml
      + '<div class="detail-row"><span class="detail-label">Descri√ß√£o:</span><span class="detail-value">' + comp.description + '</span></div>'
      + '</div>'
      + logsHtml;

    document.getElementById('detailOverlay').classList.add('active');
  }

  function closeDetail(e) {
    if (!e || e.target.id === 'detailOverlay') {
      document.getElementById('detailOverlay').classList.remove('active');
    }
  }

  // ---- Tabs ----
  function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(function(t) { t.classList.toggle('active', t.dataset.tab === tab); });
    document.querySelectorAll('.tab-content').forEach(function(tc) { tc.classList.toggle('active', tc.id === 'tab-' + tab); });
    if (tab === 'details') renderDetails();
    if (tab === 'ofertas') {
      renderOfertas();
      if (currentOferta) renderTopologyStatus();
    }
  }

  // ---- Logs ----
  function appendLog(text) {
    logBuffer += text;
    var logEl = document.getElementById('logContent');
    logEl.innerHTML = colorizeLogs(logBuffer);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function clearLogs() {
    logBuffer = '';
    document.getElementById('logContent').innerHTML = 'Logs limpos.\n';
  }

  function colorizeLogs(text) {
    return text
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/(ok:.*)/gi, '<span class="log-ok">$1</span>')
      .replace(/(changed:.*)/gi, '<span class="log-changed">$1</span>')
      .replace(/(fatal|failed|error|FAILED)(.*)$/gim, '<span class="log-err">$1$2</span>');
  }

  // ---- Modal ----
  function showModal(title, message, icon) {
    icon = icon || 'üîÑ';
    document.getElementById('modalIcon').textContent = icon;
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    document.getElementById('modalOverlay').classList.add('active');
  }
  function hideModal() {
    document.getElementById('modalOverlay').classList.remove('active');
  }
  function updateModal(title, message) {
    if (document.getElementById('modalOverlay').classList.contains('active')) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;
    }
  }

  // ---- Toasts ----
  function showToast(message, type) {
    type = type || 'info';
    var container = document.getElementById('toasts');
    var toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.innerHTML = message;
    container.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 5000);
  }
</script>

</body>
</html>
