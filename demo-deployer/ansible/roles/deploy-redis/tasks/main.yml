---
# Role: deploy-redis — deploy do Redis para o agent-ai
- name: "Verificar se Redis já existe"
  shell: "oc get deploy redis -n {{ namespace }} -o name 2>/dev/null || oc get dc redis -n {{ namespace }} -o name 2>/dev/null"
  register: redis_check
  failed_when: false
  changed_when: false

- name: "Deploy do Redis Stack (com RediSearch para embeddings)"
  command: >
    oc new-app docker.io/redis/redis-stack-server:latest
    --name=redis
    -n {{ namespace }}
  when: redis_check.stdout | default('') | length == 0
  failed_when: false
  register: redis_new_app

- name: "Aguardar criação do recurso Redis"
  pause:
    seconds: 5
  when: redis_check.stdout | default('') | length == 0

- name: "Detectar tipo de recurso Redis"
  shell: "oc get deploy redis -n {{ namespace }} -o name 2>/dev/null || oc get dc redis -n {{ namespace }} -o name 2>/dev/null"
  register: redis_resource
  changed_when: false
  failed_when: false
  retries: 5
  delay: 3
  until: redis_resource.stdout | default('') | length > 0

- name: "Aguardar Redis estar pronto"
  command: "oc rollout status {{ redis_resource.stdout }} -n {{ namespace }} --timeout=180s"
  when: redis_resource.stdout | default('') | length > 0
  changed_when: false
  failed_when: false

- name: "Obter service ClusterIP do Redis"
  command: "oc get svc redis -n {{ namespace }} -o jsonpath='{.spec.clusterIP}'"
  register: redis_ip
  changed_when: false
  failed_when: false

- name: "Registrar informações do Redis"
  set_fact:
    redis_result:
      service: "redis.{{ namespace }}.svc.cluster.local"
      port: 6379
      status: "deployed"
