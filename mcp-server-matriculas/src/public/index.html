<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Matrículas</title>
    <style>
        :root { color-scheme: light; }
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 980px;
            margin: 0 auto;
            padding: 24px;
            background-color: #f4f4f9;
            color: #222;
        }
        h1 { margin: 0 0 18px; color: #333; font-size: 28px; letter-spacing: -0.3px; }
        .subtitle { margin: 0 0 18px; color: #666; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        @media (min-width: 900px) { .grid { grid-template-columns: 380px 1fr; align-items: start; } }
        .card {
            background: white;
            padding: 18px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.06);
        }
        .card h2 { margin: 0 0 12px; font-size: 18px; color: #333; }
        label { display: block; font-size: 12px; color: #555; margin: 10px 0 6px; }
        input, select, button {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
        }
        input:focus, select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.15); }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .actions { display: flex; gap: 10px; margin-top: 12px; }
        .actions button { width: auto; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: 600; }
        button:hover { background-color: #0056b3; }
        button.secondary { background: #fff; color: #007bff; border: 1px solid rgba(0,123,255,0.35); }
        button.secondary:hover { background: rgba(0,123,255,0.06); }
        .status { margin-top: 12px; padding: 10px 12px; border-radius: 8px; font-size: 13px; display: none; }
        .status.ok { display: block; background: rgba(40,167,69,0.10); border: 1px solid rgba(40,167,69,0.25); color: #1f7a35; }
        .status.err { display: block; background: rgba(220,53,69,0.10); border: 1px solid rgba(220,53,69,0.25); color: #a61d2d; }
        .toolbar { display: flex; gap: 10px; align-items: center; }
        .toolbar input { flex: 1; }
        .toolbar button { width: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background-color: #f8f9fa; color: #555; font-weight: 600; }
        .muted { color: #666; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Sistema de Matrículas</h1>
    <p class="subtitle">Cadastre alunos apenas nos anos 5, 6, 7 e 8.</p>

    <div class="grid">
        <div class="card">
            <h2>Nova Matrícula</h2>
            <form id="enrollForm">
                <label for="name">Nome completo</label>
                <input type="text" id="name" placeholder="Ex: Maria da Silva" autocomplete="name" required>

                <div class="row">
                    <div>
                        <label for="dob">Data de nascimento</label>
                        <input type="text" id="dob" placeholder="DD/MM/AAAA" inputmode="numeric" required>
                    </div>
                    <div>
                        <label for="year">Ano</label>
                        <select id="year" required>
                            <option value="" selected disabled>Selecione</option>
                            <option value="5">5º ano</option>
                            <option value="6">6º ano</option>
                            <option value="7">7º ano</option>
                            <option value="8">8º ano</option>
                        </select>
                        <div class="muted">Apenas 5, 6, 7 e 8.</div>
                    </div>
                </div>

                <div class="actions">
                    <button type="submit">Matricular</button>
                    <button type="button" class="secondary" id="resetBtn">Limpar</button>
                </div>

                <div id="status" class="status"></div>
            </form>
        </div>

        <div class="card">
            <h2>Alunos Matriculados</h2>
            <div class="toolbar">
                <input type="text" id="searchInput" placeholder="Buscar por nome...">
                <button type="button" onclick="searchStudents()">Buscar</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width: 70px;">ID</th>
                        <th>Nome</th>
                        <th style="width: 170px;">Nascimento</th>
                        <th style="width: 120px;">Ano</th>
                    </tr>
                </thead>
                <tbody id="studentsTable">
                    <!-- Dados serão inseridos aqui -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = '/api/students';

        function showStatus(kind, message) {
            const el = document.getElementById('status');
            el.className = `status ${kind}`;
            el.textContent = message;
        }

        function formatYear(value) {
            const n = Number(value);
            if ([5,6,7,8].includes(n)) return `${n}º ano`;
            return String(value || '');
        }

        async function loadStudents(query = '') {
            const url = query ? `${API_URL}?q=${encodeURIComponent(query)}` : API_URL;
            try {
                const response = await fetch(url);
                const students = await response.json();
                renderTable(students);
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
            }
        }

        function renderTable(students) {
            const tbody = document.getElementById('studentsTable');
            tbody.innerHTML = '';
            students.forEach(student => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td>${student.dob}</td>
                    <td>${formatYear(student.year)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('enrollForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const dob = document.getElementById('dob').value;
            const year = Number(document.getElementById('year').value);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, dob, year })
                });

                if (response.ok) {
                    showStatus('ok', 'Matrícula realizada com sucesso!');
                    document.getElementById('enrollForm').reset();
                    loadStudents();
                } else {
                    const payload = await response.json().catch(() => null);
                    showStatus('err', payload?.error || 'Erro ao realizar matrícula.');
                }
            } catch (error) {
                console.error('Erro:', error);
                showStatus('err', 'Erro de rede ao realizar matrícula.');
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('enrollForm').reset();
            const el = document.getElementById('status');
            el.className = 'status';
            el.textContent = '';
        });

        function searchStudents() {
            const query = document.getElementById('searchInput').value;
            loadStudents(query);
        }

        // Carregar inicialmente
        loadStudents();
    </script>
</body>
</html>
